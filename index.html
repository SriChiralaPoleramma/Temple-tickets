<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temple Seva | Verification System</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #d84315;
            --success: #1b5e20;
            --bg: #f0f2f5;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; }
        
        /* Layout Controls */
        .container { max-width: 450px; margin: 0 auto; padding: 20px; box-sizing: border-box; }
        .card { background: white; border-radius: 24px; padding: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }

        /* Booking UI Styles */
        header { background: #bf360c; color: white; padding: 40px 20px; text-align: center; border-radius: 0 0 40px 40px; margin-bottom: -30px; }
        .input-box { margin-bottom: 15px; }
        label { display: block; font-size: 12px; font-weight: 700; color: #666; text-transform: uppercase; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; margin-top: 10px; }

        /* Receipt UI */
        .receipt { background: white; border-radius: 20px; border: 1px solid #ddd; overflow: hidden; }
        .receipt-head { background: #f8f9fa; padding: 20px; text-align: center; border-bottom: 2px dashed #ccc; }
        .receipt-body { padding: 25px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .row b { color: #333; }
        .qr-area { background: #fcfcfc; padding: 15px; border-radius: 15px; display: flex; justify-content: center; margin: 15px 0; border: 1px solid #f0f0f0; }

        /* --- VERIFICATION SCREEN STYLES --- */
        #verifyLayout { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #e8f5e9; }
        .verify-card { width: 90%; max-width: 380px; background: white; border-radius: 30px; padding: 40px 20px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.1); border-top: 8px solid var(--success); }
        .v-icon { font-size: 60px; color: var(--success); margin-bottom: 20px; }
        .v-title { font-size: 24px; font-weight: 800; color: #1b5e20; margin: 0; }
        .v-subtitle { font-size: 14px; color: #666; margin-bottom: 30px; }
        .v-data { text-align: left; background: #f9f9f9; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="fullApp">
    <header>
        <h1 style="margin:0; font-size: 22px;">శ్రీ పోలేరమ్మ తల్లి</h1>
        <p style="margin:5px 0 0; opacity: 0.8; font-size: 14px;">Official Pooja Booking</p>
    </header>

    <div class="container">
        <div id="bookingBox" class="card">
            <h2 style="text-align:center; color: var(--primary); margin-top: 0;">New Booking</h2>
            <form id="pForm">
                <div class="input-box">
                    <label>Devotee Name</label>
                    <input type="text" id="name" required placeholder="Enter name">
                </div>
                <div class="input-box">
                    <label>Mobile Number</label>
                    <input type="tel" id="phone" required maxlength="10">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="input-box"><label>Start</label><input type="date" id="sDate" required></div>
                    <div class="input-box"><label>End</label><input type="date" id="eDate" required disabled></div>
                </div>
                <div style="text-align:center; padding:15px; background:#fff8e1; border-radius:12px; margin:10px 0;">
                    <div id="totalPrice" style="font-size: 24px; font-weight: 900; color: #e65100;">₹0</div>
                </div>
                <button type="submit" class="btn btn-main">Generate Digital Ticket</button>
            </form>
        </div>

        <div id="ticketBox" class="hidden">
            <div id="captureArea" class="receipt">
                <div class="receipt-head">
                    <div style="font-weight:800; color:var(--success);"><i class="fas fa-check-circle"></i> PAID RECEIPT</div>
                    <div id="t-id" style="font-size: 10px; color: #999; margin-top: 5px;"></div>
                </div>
                <div class="receipt-body">
                    <div class="row"><span>Devotee:</span> <b id="t-name"></b></div>
                    <div class="row"><span>Validity:</span> <b id="t-val"></b></div>
                    <div class="qr-area"><div id="qrcode"></div></div>
                    <div style="text-align:center;">
                        <span style="font-size:11px; color:#aaa;">TOTAL AMOUNT</span>
                        <div style="font-size:20px; font-weight:900; color:var(--success);">₹<span id="t-amt"></span></div>
                    </div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
                <button onclick="downloadImg()" class="btn" style="background:#444; color:white;">Download</button>
                <button onclick="share()" class="btn" style="background:#25d366; color:white;">WhatsApp</button>
            </div>
        </div>
    </div>
</div>

<div id="verifyLayout" class="hidden">
    <div class="verify-card">
        <div class="v-icon"><i class="fas fa-certificate"></i></div>
        <h2 class="v-title">Verified Ticket</h2>
        <p class="v-subtitle">Official Temple Record Found</p>
        
        <div class="v-data" id="vContent">
            </div>

        <div style="color: #2e7d32; font-weight: 700; font-size: 13px; margin-bottom: 20px;">
            <i class="fas fa-shield-alt"></i> Digital Signature Verified
        </div>
        
        <button onclick="window.location.href=window.location.pathname" class="btn" style="background:#f0f0f0; color:#444;">Back to Home</button>
    </div>
</div>

<script>
    const sInput = document.getElementById('sDate');
    const eInput = document.getElementById('eDate');
    sInput.min = new Date().toISOString().split('T')[0];

    sInput.onchange = () => { eInput.disabled = false; eInput.min = sInput.value; updatePrice(); };
    eInput.onchange = updatePrice;

    function updatePrice() {
        if(!sInput.value || !eInput.value) return 0;
        const d1 = new Date(sInput.value); const d2 = new Date(eInput.value);
        let diff = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
        diff = diff < 0 ? 0 : diff;
        document.getElementById('totalPrice').innerText = `₹${diff * 100}`;
        return diff;
    }

    document.getElementById('pForm').onsubmit = (e) => {
        e.preventDefault();
        const months = updatePrice();
        if(months === 0) return Swal.fire("Select Dates", "Minimum 1 month required", "info");

        const tid = "POL-" + Math.random().toString(36).substr(2, 6).toUpperCase();
        const name = document.getElementById('name').value;
        const amt = months * 100;

        // Populate Ticket
        document.getElementById('t-id').innerText = tid;
        document.getElementById('t-name').innerText = name;
        document.getElementById('t-val').innerText = `${sInput.value} / ${eInput.value}`;
        document.getElementById('t-amt').innerText = amt;

        // GENERATE SMART URL
        const currentPath = window.location.href.split('?')[0];
        const verifyLink = `${currentPath}?verify=1&id=${tid}&n=${encodeURIComponent(name)}&a=${amt}&p=${document.getElementById('phone').value}`;

        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: verifyLink, width: 150, height: 150 });

        document.getElementById('bookingBox').classList.add('hidden');
        document.getElementById('ticketBox').classList.remove('hidden');
    };

    // ON LOAD: CHECK IF SCANNER OPENED THE LINK
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if (params.has('verify')) {
            // HIDE EVERYTHING ELSE
            document.getElementById('fullApp').remove(); // Completely remove booking UI
            document.getElementById('verifyLayout').classList.remove('hidden');

            // Show clean verification data
            document.getElementById('vContent').innerHTML = `
                <div class="row"><span>Devotee:</span> <b>${params.get('n')}</b></div>
                <div class="row"><span>Ticket ID:</span> <b>${params.get('id')}</b></div>
                <div class="row"><span>Phone:</span> <b>${params.get('p')}</b></div>
                <div class="row"><span>Payment:</span> <b style="color:green">₹${params.get('a')} (PAID)</b></div>
                <div class="row" style="margin-top:10px; border-top:1px solid #eee; pt:10px;">
                    <span>Dated:</span> <b>${new Date().toLocaleDateString()}</b>
                </div>
            `;
        }
    };

    function downloadImg() {
        html2canvas(document.getElementById('captureArea')).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Temple_Receipt.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function share() {
        const msg = `*శ్రీ పోలేరమ్మ తల్లి ఆలయం*%0Aభక్తుని పేరు: ${document.getElementById('t-name').innerText}%0Aరశీదు: PAID ✅`;
        window.open(`https://wa.me/91${document.getElementById('phone').value}?text=${msg}`);
    }
</script>

</body>
                    </html>
                    
