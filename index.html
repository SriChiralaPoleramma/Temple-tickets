<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pooja Booking & Verification - Poleramma Temple</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { 
            --primary: #bf360c; 
            --secondary: #e65100; 
            --accent: #ff9800;
            --success: #1b5e20;
            --bg: #f8f9fa; 
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; color: #2d3436; 
        }
        
        /* Modern Header */
        header { 
            background: linear-gradient(135deg, #880e4f 0%, #bf360c 100%); 
            color: white; text-align: center; padding: 50px 20px; 
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
        }

        .container { max-width: 500px; margin: -50px auto 50px; padding: 0 20px; }
        
        .card { 
            background: white; padding: 30px; border-radius: 24px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05);
        }

        h2 { color: var(--primary); font-size: 1.4rem; text-align: center; margin-bottom: 25px; }
        
        /* Form Styling */
        .input-group { margin-bottom: 18px; }
        label { font-size: 0.75rem; font-weight: 800; color: #636e72; display: block; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        input { 
            width: 100%; padding: 15px; border: 2px solid #edf2f7; border-radius: 12px; 
            box-sizing: border-box; font-size: 1rem; transition: all 0.3s ease;
        }
        input:focus { border-color: var(--secondary); outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(230, 81, 0, 0.1); }
        
        .price-card { 
            background: #fff8f1; border: 2px dashed var(--accent); 
            padding: 20px; border-radius: 16px; text-align: center; margin: 20px 0;
        }

        .btn-main { 
            width: 100%; background: var(--secondary); color: white; border: none; 
            padding: 18px; border-radius: 12px; font-weight: 700; font-size: 1.1rem;
            cursor: pointer; transition: 0.3s; box-shadow: 0 8px 20px rgba(230, 81, 0, 0.3);
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(230, 81, 0, 0.4); }

        /* Ticket UI */
        .ticket { background: white; border-radius: 20px; overflow: hidden; position: relative; margin-top: 30px; }
        .ticket-top { background: #fdfdfd; padding: 25px; border-bottom: 2px dashed #eee; text-align: center; }
        .ticket-body { padding: 30px; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.95rem; }
        .data-row span { color: #888; }
        .data-row b { color: #2d3436; }
        
        #qrcode { display: flex; justify-content: center; margin: 25px 0; }
        #qrcode img { border: 10px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        .verified-badge {
            background: #e8f5e9; color: var(--success); padding: 15px;
            border-radius: 12px; text-align: center; font-weight: 800;
            border: 1px solid #c8e6c9; display: none; margin-bottom: 20px;
        }

        .hidden { display: none; }
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-sec { padding: 12px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; color: white; }
    </style>
</head>
<body>

<header id="pageHeader">
    <h1 style="margin:0; font-size: 1.6rem;">‡∞∂‡±ç‡∞∞‡±Ä ‡∞™‡±ã‡∞≤‡±á‡∞∞‡∞Æ‡±ç‡∞Æ ‡∞§‡∞≤‡±ç‡∞≤‡∞ø ‡∞¶‡±á‡∞µ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç</h1>
    <p style="margin:5px 0 0; opacity: 0.8; font-size: 0.9rem;">Official Digital Seva Portal</p>
</header>

<div class="container">
    <div id="verifySection" class="card hidden" style="margin-top: 20px; border: 2px solid var(--success);">
        <div class="verified-badge" id="vBadge" style="display: block;">
            <i class="fas fa-check-circle"></i> ‡∞Ü‡∞≤‡∞Ø ‡∞Ö‡∞ß‡∞ø‡∞ï‡∞æ‡∞∞‡∞ø ‡∞ß‡±É‡∞µ‡±Ä‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞æ‡∞∞‡±Å (VERIFIED)
        </div>
        <h3 style="text-align: center; margin: 0 0 20px 0;">Transaction Details</h3>
        <div id="vDetails"></div>
        <button onclick="location.href=location.pathname" class="btn-main" style="margin-top:20px; background:#636e72;">Back to Booking</button>
    </div>

    <div id="bookingSection" class="card">
        <h2>üìú ‡∞™‡±Ç‡∞ú‡∞æ ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç</h2>
        <form id="bookingForm">
            <div class="input-group">
                <label>‡∞≠‡∞ï‡±ç‡∞§‡±Å‡∞®‡∞ø ‡∞™‡±á‡∞∞‡±Å (Devotee Name)</label>
                <input type="text" id="name" required placeholder="Enter full name">
            </div>
            <div class="input-group">
                <label>‡∞Æ‡±ä‡∞¨‡±à‡∞≤‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç</label>
                <input type="tel" id="phone" required maxlength="10" placeholder="10 digit mobile number">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="input-group">
                    <label>‡∞™‡±ç‡∞∞‡∞æ‡∞∞‡∞Ç‡∞≠ ‡∞§‡±á‡∞¶‡±Ä</label>
                    <input type="date" id="startDate" required>
                </div>
                <div class="input-group">
                    <label>‡∞Æ‡±Å‡∞ó‡∞ø‡∞Ç‡∞™‡±Å ‡∞§‡±á‡∞¶‡±Ä</label>
                    <input type="date" id="endDate" required disabled>
                </div>
            </div>

            <div class="price-card">
                <div id="calcText" style="font-size: 0.85rem; color: #666;">Select duration</div>
                <div id="totalDisplay" style="font-size: 2rem; font-weight: 800; color: var(--primary);">‚Çπ0</div>
            </div>

            <button type="submit" class="btn-main">Confirm & Generate QR</button>
        </form>
    </div>

    <div id="ticketOutput" class="hidden">
        <div id="ticketCapture" class="ticket shadow">
            <div class="ticket-top">
                <b style="color:var(--primary); letter-spacing: 1px;">E-RECEIPT</b>
                <div id="t-id" style="font-size: 0.75rem; color: #999; margin-top: 5px;"></div>
            </div>
            <div class="ticket-body">
                <div class="data-row"><span>Devotee</span> <b id="t-name"></b></div>
                <div class="data-row"><span>Mobile</span> <b id="t-phone"></b></div>
                <div class="data-row"><span>Validity</span> <b id="t-period"></b></div>
                
                <div id="qrcode"></div>
                
                <div style="background: #1b5e20; color:white; padding: 15px; border-radius: 12px; text-align: center;">
                    <span style="font-size: 0.8rem; opacity: 0.9;">TOTAL PAID</span>
                    <div style="font-size: 1.5rem; font-weight: 800;">‚Çπ<span id="t-total"></span></div>
                </div>
                <p style="text-align:center; font-size: 0.65rem; color: #bbb; margin-top: 15px;">Scan this QR at Temple Entrance for Verification</p>
            </div>
        </div>
        
        <div class="actions">
            <button onclick="downloadTicket()" class="btn-sec" style="background:#0d47a1"><i class="fas fa-download"></i> Save</button>
            <button onclick="shareWA()" class="btn-sec" style="background:#2e7d32"><i class="fab fa-whatsapp"></i> Share</button>
        </div>
    </div>
</div>

<script>
    const startIn = document.getElementById('startDate');
    const endIn = document.getElementById('endDate');

    // 1. Initial Logic
    startIn.min = new Date().toISOString().split('T')[0];

    startIn.onchange = () => {
        endIn.disabled = false;
        endIn.min = startIn.value;
        calcPrice();
    };
    endIn.onchange = calcPrice;

    function calcPrice() {
        if (!startIn.value || !endIn.value) return 0;
        const d1 = new Date(startIn.value);
        const d2 = new Date(endIn.value);
        let months = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
        months = months < 0 ? 0 : months;
        
        document.getElementById('calcText').innerText = `Total Duration: ${months} Months`;
        document.getElementById('totalDisplay').innerText = `‚Çπ${months * 100}`;
        return { total: months * 100, months };
    }

    // 2. Booking Handler
    document.getElementById('bookingForm').onsubmit = (e) => {
        e.preventDefault();
        const priceData = calcPrice();
        if(priceData.total === 0) {
            Swal.fire("Note", "Please select a duration of at least 1 month", "info");
            return;
        }

        const tid = "POL" + Math.random().toString(36).substr(2, 9).toUpperCase();
        const name = document.getElementById('name').value;
        const phone = document.getElementById('phone').value;

        // DATA FOR TICKET
        document.getElementById('t-id').innerText = "ID: " + tid;
        document.getElementById('t-name').innerText = name;
        document.getElementById('t-phone').innerText = phone;
        document.getElementById('t-period').innerText = `${startIn.value} to ${endIn.value}`;
        document.getElementById('t-total').innerText = priceData.total;

        // DEVELOPER LOGIC: Generate the Verification Link
        // We use the current website URL + parameters
        const currentUrl = window.location.href.split('?')[0];
        const verifyUrl = `${currentUrl}?tid=${tid}&name=${encodeURIComponent(name)}&amt=${priceData.total}&status=PAID`;

        const qrContainer = document.getElementById("qrcode");
        qrContainer.innerHTML = "";
        new QRCode(qrContainer, {
            text: verifyUrl,
            width: 180,
            height: 180,
            colorDark : "#1b5e20",
            correctLevel : QRCode.CorrectLevel.H
        });

        document.getElementById('ticketOutput').classList.remove('hidden');
        document.getElementById('bookingSection').classList.add('hidden');
        Swal.fire("Success", "Booking Confirmed!", "success");
    };

    // 3. SCANNER / VERIFICATION LOGIC
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if(params.has('tid')) {
            // Hide booking, show verification
            document.getElementById('bookingSection').classList.add('hidden');
            document.getElementById('pageHeader').style.background = "linear-gradient(135deg, #1b5e20, #43a047)";
            document.getElementById('verifySection').classList.remove('hidden');

            document.getElementById('vDetails').innerHTML = `
                <div class="data-row"><span>Transaction ID:</span> <b>${params.get('tid')}</b></div>
                <div class="data-row"><span>Devotee Name:</span> <b>${params.get('name')}</b></div>
                <div class="data-row"><span>Amount Paid:</span> <b style="color:green">‚Çπ${params.get('amt')}</b></div>
                <div class="data-row"><span>Status:</span> <b style="color:green">VERIFIED ‚úì</b></div>
                <div class="data-row"><span>Server Time:</span> <b>${new Date().toLocaleString()}</b></div>
            `;
        }
    };

    // Utils
    function downloadTicket() {
        html2canvas(document.getElementById('ticketCapture')).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Temple_Receipt.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function shareWA() {
        const text = `*‡∞∂‡±ç‡∞∞‡±Ä ‡∞™‡±ã‡∞≤‡±á‡∞∞‡∞Æ‡±ç‡∞Æ ‡∞§‡∞≤‡±ç‡∞≤‡∞ø ‡∞Ü‡∞≤‡∞Ø‡∞Ç - ‡∞∞‡∞∂‡±Ä‡∞¶‡±Å*%0A‡∞≠‡∞ï‡±ç‡∞§‡±Å‡∞®‡∞ø ‡∞™‡±á‡∞∞‡±Å: ${document.getElementById('t-name').innerText}%0A‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç: ‚Çπ${document.getElementById('t-total').innerText}%0A‡∞∏‡±ç‡∞ü‡±á‡∞ü‡∞∏‡±ç: PAID ‚úÖ`;
        window.open(`https://wa.me/91${document.getElementById('phone').value}?text=${text}`);
    }
</script>

</body>
                    </html>
                    
