<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>శ్రీ పోలేరమ్మ తల్లి | Divine Portal</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Mukta+Vaani:wght@400;700&family=Poppins:wght@300;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root { --maroon: #8e0000; --gold: #d4af37; --deep-orange: #ff5722; --sand: #fff9f0; }
        
        body { 
            font-family: 'Mukta Vaani', sans-serif; 
            background: var(--sand); 
            margin: 0; 
            background-image: radial-gradient(#d4af37 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        header { 
            background: white; padding: 40px 20px; text-align: center; 
            border-bottom: 5px solid var(--gold);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .om-symbol { font-size: 50px; color: var(--maroon); line-height: 1; }

        .container { max-width: 450px; margin: -30px auto 50px; padding: 0 15px; }

        .card { 
            background: white; border-radius: 25px; padding: 30px; 
            box-shadow: 0 15px 35px rgba(142,0,0,0.1); border: 1px solid #eee;
        }

        .input-group { margin-bottom: 18px; }
        label { display: block; font-size: 12px; font-weight: 700; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        input { 
            width: 100%; padding: 14px; border: 2px solid #efefef; border-radius: 12px; 
            font-size: 16px; transition: 0.3s;
        }
        input:focus { border-color: var(--maroon); outline: none; background: #fffcfc; }

        .price-box { 
            background: #fff8e1; border: 2px dashed var(--gold); border-radius: 15px; 
            padding: 15px; text-align: center; margin: 20px 0; 
        }

        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 15px; 
            font-weight: 700; font-size: 16px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-main { background: var(--maroon); color: white; }
        .btn-wa { background: #25D366; color: white; margin-top: 10px; }

        /* Receipt Styling */
        #captureArea { background: white; border: 1px solid #ddd; border-radius: 20px; overflow: hidden; }
        .r-header { background: var(--maroon); color: white; padding: 25px; text-align: center; }
        .r-body { padding: 25px; }
        .r-line { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; font-size: 15px; }
        
        .hidden { display: none; }
        #qrcode { margin-top: 15px; padding: 10px; background: white; display: inline-block; border: 1px solid #eee; }
    </style>
</head>
<body>

<header>
    <div class="om-symbol">ॐ</div>
    <h1 style="margin:5px 0; font-size: 26px; color: var(--maroon);">శ్రీ పోలేరమ్మ తల్లి ఆలయం</h1>
    <div style="font-size: 12px; letter-spacing: 2px; color: var(--gold); font-weight: bold;">CHIRALA • DIGITAL SEVA</div>
</header>

<div class="container">
    <div id="bookingCard" class="card">
        <form id="mainForm">
            <div class="input-group">
                <label>Devotee Name (భక్తుని పేరు)</label>
                <input type="text" id="dev_name" name="dev_name" required placeholder="Enter Name">
            </div>
            <div class="input-group">
                <label>WhatsApp Number</label>
                <input type="tel" id="dev_mobile" name="dev_mobile" pattern="[6-9][0-9]{9}" required placeholder="10 Digit Mobile">
            </div>
            <div class="input-group">
                <label>Gothram (గోత్రం)</label>
                <input type="text" id="dev_goth" name="dev_goth" placeholder="Optional">
            </div>
            <div style="display: flex; gap: 10px;">
                <div class="input-group" style="flex:1;">
                    <label>From Date</label>
                    <input type="date" id="sDate" name="start_date" required>
                </div>
                <div class="input-group" style="flex:1;">
                    <label>To Date</label>
                    <input type="date" id="eDate" name="end_date" required disabled>
                </div>
            </div>

            <div class="price-box">
                <div id="priceDisplay" style="font-size: 28px; font-weight: 800; color: var(--maroon);">₹ 0</div>
                <small id="durationDisplay" style="color: #666;">Select dates to calculate</small>
            </div>

            <button type="submit" class="btn btn-main">Generate Digital Receipt</button>
        </form>
    </div>

    <div id="receiptCard" class="hidden">
        <div id="captureArea">
            <div class="r-header">
                <h3 style="margin:0;">OFFICIAL E-RECEIPT</h3>
                <small id="ticketId" style="opacity: 0.8;"></small>
            </div>
            <div class="r-body">
                <div class="r-line"><span>Name:</span><b id="out-name"></b></div>
                <div class="r-line"><span>Gothram:</span><b id="out-goth"></b></div>
                <div class="r-line"><span>Validity:</span><b id="out-dates"></b></div>
                <div class="r-line" style="border:none; background:#fff9e6; margin-top:10px; padding:15px; border-radius:10px;">
                    <span>Total Paid:</span><b style="font-size:20px; color:var(--maroon)" id="out-amt"></b>
                </div>
                <center><div id="qrcode"></div></center>
            </div>
        </div>
        
        <button onclick="shareWA()" class="btn btn-wa"><i class="fab fa-whatsapp"></i> Share on WhatsApp</button>
        <button onclick="downloadImg()" class="btn" style="background:#444; color:white; margin-top:10px;"><i class="fas fa-download"></i> Download Image</button>
        <button onclick="location.reload()" class="btn" style="background:none; color:var(--maroon); border:1px solid var(--maroon); margin-top:15px;">New Registration</button>
    </div>
</div>

<script>
    const sDate = document.getElementById('sDate');
    const eDate = document.getElementById('eDate');
    
    // Set min date to today
    sDate.min = new Date().toISOString().split('T')[0];

    sDate.onchange = () => {
        eDate.disabled = false;
        eDate.min = sDate.value;
        calcPrice();
    };
    eDate.onchange = calcPrice;

    function calcPrice() {
        if(!sDate.value || !eDate.value) return 0;
        const d1 = new Date(sDate.value);
        const d2 = new Date(eDate.value);
        
        let months = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
        if (d2.getDate() < d1.getDate()) months--;
        
        const count = months < 1 ? 1 : months;
        const total = count * 100;
        
        document.getElementById('priceDisplay').innerText = `₹ ${total}`;
        document.getElementById('durationDisplay').innerText = `${count} Month(s) Duration`;
        return total;
    }

    document.getElementById('mainForm').onsubmit = async (e) => {
        e.preventDefault();
        const amt = calcPrice();
        const tid = "PLM-" + Math.random().toString(36).substr(2, 6).toUpperCase();
        
        Swal.fire({ title: 'Saving to Records...', didOpen: () => Swal.showLoading() });

        const formData = new FormData(e.target);
        formData.append("id", tid);
        formData.append("total", amt);

        try {
            // "google.script.run" connects to the Apps Script backend
            google.script.run.withSuccessHandler(() => {
                showReceipt(tid, amt);
                Swal.close();
            }).doPost(Object.fromEntries(formData));
        } catch(err) {
            // Local testing fallback
            showReceipt(tid, amt);
            Swal.close();
        }
    };

    function showReceipt(tid, amt) {
        document.getElementById('out-name').innerText = document.getElementById('dev_name').value;
        document.getElementById('out-goth').innerText = document.getElementById('dev_goth').value || "Not Provided";
        document.getElementById('out-dates').innerText = `${sDate.value} to ${eDate.value}`;
        document.getElementById('out-amt').innerText = `₹${amt}/-`;
        document.getElementById('ticketId').innerText = tid;

        // Generate QR code with a verification link
        const vUrl = `https://example.com/verify?id=${tid}`; // Replace with actual verify link if needed
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), { text: vUrl, width: 120, height: 120 });

        document.getElementById('bookingCard').classList.add('hidden');
        document.getElementById('receiptCard').classList.remove('hidden');
    }

    function downloadImg() {
        html2canvas(document.getElementById('captureArea')).then(canvas => {
            const link = document.createElement('a');
            link.download = `Poleramma_Receipt.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function shareWA() {
        const name = document.getElementById('out-name').innerText;
        const amt = document.getElementById('out-amt').innerText;
        const text = `*శ్రీ పోలేరమ్మ తల్లి ఆలయం* %0A---%0Aభక్తుని పేరు: ${name}%0Aమొత్తం: ${amt}%0Aరసీదు కోసం పై చిత్రాన్ని సేవ్ చేసుకోగలరు.`;
        const phone = document.getElementById('dev_mobile').value;
        window.open(`https://wa.me/91${phone}?text=${text}`, '_blank');
    }
</script>

</body>
                </html>
    
