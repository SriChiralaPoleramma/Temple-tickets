<!DOCTYPE html>
<html lang="te">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pooja Booking - Poleramma Temple</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="bg-gradient"></div>

<header>
    <div class="logo-container">
        <img src="templeimage/1742626228036 (1).jpg" alt="Logo" class="header-logo">
        <h1>‡∞∂‡±ç‡∞∞‡±Ä ‡∞∂‡±ç‡∞∞‡±Ä ‡∞∂‡±ç‡∞∞‡±Ä ‡∞ö‡±Ä‡∞∞‡∞æ‡∞≤ ‡∞™‡±ã‡∞≤‡±á‡∞∞‡∞Æ‡±ç‡∞Æ ‡∞§‡∞≤‡±ç‡∞≤‡∞ø ‡∞¶‡±á‡∞µ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç</h1>
    </div>
</header>

<main class="booking-container">
    <div class="booking-card">
        <div class="card-header">
            <h2><i class="fas fa-scroll"></i> ‡∞™‡±Ç‡∞ú‡∞æ ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç</h2>
            <p>‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡∞®‡±Å ‡∞®‡∞Æ‡±ã‡∞¶‡±Å ‡∞ö‡±á‡∞∏‡∞ø ‡∞´‡±ã‡∞ü‡±ã ‡∞ü‡∞ø‡∞ï‡±Ü‡∞ü‡±ç ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø</p>
        </div>
        
        <form id="monthlyForm">
            <div class="input-group">
                <label><i class="fas fa-user"></i> ‡∞™‡±á‡∞∞‡±Å</label>
                <input type="text" id="name" required placeholder="‡∞Æ‡±Ä ‡∞™‡±á‡∞∞‡±Å">
            </div>

            <div class="input-group">
                <label><i class="fas fa-phone"></i> ‡∞´‡±ã‡∞®‡±ç ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç</label>
                <input type="tel" id="phone" required placeholder="10 ‡∞Ö‡∞Ç‡∞ï‡±Ü‡∞≤ ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç" maxlength="10">
            </div>

            <div class="input-group">
                <label><i class="fas fa-om"></i> ‡∞ó‡±ã‡∞§‡±ç‡∞∞‡∞Ç</label>
                <input type="text" id="gothram" required placeholder="‡∞â‡∞¶‡∞æ: ‡∞µ‡∞æ‡∞∏‡∞ø‡∞∑‡±ç‡∞†">
            </div>

            <div class="row">
                <div class="col">
                    <label>üìÖ ‡∞™‡±ç‡∞∞‡∞æ‡∞∞‡∞Ç‡∞≠ ‡∞§‡±á‡∞¶‡±Ä</label>
                    <input type="date" id="startDate" required>
                </div>
                <div class="col">
                    <label>üìÖ ‡∞Æ‡±Å‡∞ó‡∞ø‡∞Ç‡∞™‡±Å ‡∞§‡±á‡∞¶‡±Ä</label>
                    <input type="date" id="endDate" required>
                </div>
            </div>

            <div id="priceSummary" class="price-summary-card">
                <span id="durationText">‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞Ø‡∞ø‡∞® ‡∞®‡±Ü‡∞≤‡∞≤‡±Å: 0</span>
                <h3 id="totalCost">‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç: ‚Çπ0</h3>
            </div>

            <button type="submit" class="monthly-btn">üõï ‡∞¨‡±Å‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø & ‡∞´‡±ã‡∞ü‡±ã ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø</button>
        </form>
    </div>

    <section id="ticketOutput" class="hidden">
        <div class="ticket-wrapper">
            <div class="ticket-card" id="captureTicket">
                <div class="ticket-top-border"></div>
                <div class="paid-stamp-box">PAID</div>
                
                <div class="ticket-header">
                    <img src="templeimage/1742626228036 (1).jpg" alt="Logo" class="ticket-logo">
                    <h3>‡∞ü‡∞ø‡∞ï‡±Ü‡∞ü‡±ç ‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç ‡∞®‡∞ø‡∞∞‡±ç‡∞ß‡∞æ‡∞∞‡∞£</h3>
                    <p class="temple-name">‡∞ö‡±Ä‡∞∞‡∞æ‡∞≤ ‡∞™‡±ã‡∞≤‡±á‡∞∞‡∞Æ‡±ç‡∞Æ ‡∞§‡∞≤‡±ç‡∞≤‡∞ø ‡∞¶‡±á‡∞µ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç</p>
                </div>
                
                <div class="ticket-body">
                    <div class="t-row"><span>ID:</span> <b id="t-id"></b></div>
                    <div class="t-row"><span>‡∞§‡±á‡∞¶‡±Ä:</span> <span id="t-date"></span></div>
                    <div class="divider"></div>
                    <div class="t-row"><span>‡∞™‡±á‡∞∞‡±Å:</span> <span id="t-name"></span></div>
                    <div class="t-row"><span>‡∞ó‡±ã‡∞§‡±ç‡∞∞‡∞Ç:</span> <b id="t-gothram"></b></div>
                    <div class="t-row"><span>‡∞´‡±ã‡∞®‡±ç:</span> <span id="t-phone"></span></div>
                    <div class="t-row"><span>‡∞™‡±ç‡∞∞‡∞æ‡∞∞‡∞Ç‡∞≠‡∞Ç:</span> <span id="t-start"></span></div>
                    <div class="t-row"><span>‡∞Æ‡±Å‡∞ó‡∞ø‡∞Ç‡∞™‡±Å:</span> <span id="t-end"></span></div>
                    
                    <div class="price-highlight">
                        <p>‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞ö‡±Ü‡∞≤‡±ç‡∞≤‡∞ø‡∞Ç‡∞™‡±Å</p>
                        <b>‚Çπ<span id="t-total"></span></b>
                    </div>
                </div>
            </div>
            
            <div class="ticket-actions">
                <button onclick="shareAsImage()" class="action-btn btn-jpg">
                    <i class="fas fa-image"></i> WhatsApp ‡∞´‡±ã‡∞ü‡±ã
                </button>
            </div>
        </div>
    </section>
</main>

<div id="spinner" class="spinner hidden"></div>

<script>
const SCRIPT_URL = "PASTE_YOUR_APPSCRIPT_URL_HERE";
const form = document.getElementById('monthlyForm');
const startInput = document.getElementById('startDate');
const endInput = document.getElementById('endDate');
let bookingData = {};

// Date Logic
startInput.addEventListener('change', function() {
    if (this.value) {
        endInput.min = this.value;
        if (endInput.value && endInput.value < this.value) endInput.value = "";
    }
    updatePrice();
});
endInput.addEventListener('change', updatePrice);

function updatePrice() {
    const startVal = startInput.value;
    const endVal = endInput.value;
    if (startVal && endVal) {
        const d1 = new Date(startVal);
        const d2 = new Date(endVal);
        let months = (d2.getFullYear() - d1.getFullYear()) * 12;
        months -= d1.getMonth();
        months += d2.getMonth();
        if (d2.getDate() < d1.getDate()) months--;
        const finalMonths = months <= 0 ? 0 : months;
        document.getElementById('durationText').innerText = `‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞Ø‡∞ø‡∞® ‡∞®‡±Ü‡∞≤‡∞≤‡±Å: ${finalMonths}`;
        document.getElementById('totalCost').innerText = `‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç: ‚Çπ${finalMonths * 100}`;
        return { total: finalMonths * 100, count: finalMonths };
    }
    return { total: 0, count: 0 };
}

form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const { total, count } = updatePrice();
    if (count <= 0) return Swal.fire("‡∞ó‡∞Æ‡∞®‡∞ø‡∞ï", "‡∞ï‡∞®‡±Ä‡∞∏‡∞Ç ‡∞í‡∞ï ‡∞®‡±Ü‡∞≤ ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞ø ‡∞ï‡∞æ‡∞µ‡∞æ‡∞≤‡∞ø", "warning");

    document.getElementById('spinner').classList.remove('hidden');
    bookingData = {
        bookingID: "POL-" + Date.now().toString().slice(-6),
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        gothram: document.getElementById('gothram').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        totalAmount: total,
        bookingDate: new Date().toLocaleString('en-IN')
    };

    try {
        const formData = new FormData();
        for (let key in bookingData) formData.append(key, bookingData[key]);
        await fetch(SCRIPT_URL, { method: 'POST', body: formData });

        document.getElementById('spinner').classList.add('hidden');
        
        // Fill Ticket Details
        document.getElementById('t-id').innerText = bookingData.bookingID;
        document.getElementById('t-date').innerText = bookingData.bookingDate;
        document.getElementById('t-name').innerText = bookingData.name;
        document.getElementById('t-gothram').innerText = bookingData.gothram;
        document.getElementById('t-phone').innerText = bookingData.phone;
        document.getElementById('t-start').innerText = bookingData.startDate;
        document.getElementById('t-end').innerText = bookingData.endDate;
        document.getElementById('t-total').innerText = total;
        
        document.getElementById('ticketOutput').classList.remove('hidden');
        Swal.fire("‡∞µ‡∞ø‡∞ú‡∞Ø‡∞Ç!", "‡∞¨‡±Å‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø. ‡∞ï‡±ç‡∞∞‡∞ø‡∞Ç‡∞¶ ‡∞â‡∞®‡±ç‡∞® ‡∞¨‡∞ü‡∞®‡±ç ‡∞®‡±ä‡∞ï‡±ç‡∞ï‡∞ø ‡∞´‡±ã‡∞ü‡±ã ‡∞∑‡±á‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.", "success");
    } catch (err) {
        document.getElementById('spinner').classList.add('hidden');
        Swal.fire("Error", "‡∞∏‡∞∞‡±ç‡∞µ‡∞∞‡±ç ‡∞∏‡∞Æ‡∞∏‡±ç‡∞Ø", "error");
    }
});

// IMAGE GENERATION & SHARING
async function shareAsImage() {
    const ticketElement = document.getElementById('captureTicket');
    
    // Create Image from HTML
    const canvas = await html2canvas(ticketElement, { scale: 2, useCORS: true });
    const imgData = canvas.toDataURL("image/jpeg", 0.9);

    // Convert to file for sharing
    const blob = await (await fetch(imgData)).blob();
    const file = new File([blob], `Poleramma_Ticket_${bookingData.bookingID}.jpg`, { type: "image/jpeg" });

    // Try Native Sharing (Works on mobile browsers)
    if (navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
            await navigator.share({
                files: [file],
                title: 'Temple Ticket',
                text: `ID: ${bookingData.bookingID} - ${bookingData.name}`
            });
        } catch (error) {
            fallbackWhatsApp(imgData);
        }
    } else {
        fallbackWhatsApp(imgData);
    }
}

function fallbackWhatsApp(imgData) {
    // If browser doesn't support file sharing, we download and open WhatsApp
    const link = document.createElement('a');
    link.href = imgData;
    link.download = `Ticket_${bookingData.bookingID}.jpg`;
    link.click();
    
    setTimeout(() => {
        const text = `*‡∞∂‡±ç‡∞∞‡±Ä ‡∞™‡±ã‡∞≤‡±á‡∞∞‡∞Æ‡±ç‡∞Æ ‡∞Ü‡∞≤‡∞Ø ‡∞ü‡∞ø‡∞ï‡±Ü‡∞ü‡±ç*%0Aüîñ ID: ${bookingData.bookingID}%0Aüë§ ‡∞™‡±á‡∞∞‡±Å: ${bookingData.name}%0A‚úÖ Status: PAID%0A%0A‡∞®‡±á‡∞®‡±Å ‡∞ü‡∞ø‡∞ï‡±Ü‡∞ü‡±ç ‡∞´‡±ã‡∞ü‡±ã ‡∞°‡±å‡∞®‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞∂‡∞æ‡∞®‡±Å. ‡∞¶‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞™‡∞Ç‡∞™‡±Å‡∞§‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞®‡±Å.`;
        window.open(`https://wa.me/91${bookingData.phone}?text=${text}`, '_blank');
    }, 1500);
}
</script>

<style>
/* Clean & Professional Styling */
:root { --primary: #e65100; --bg: #fdf5e6; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
header { background: white; padding: 15px; text-align: center; border-bottom: 3px solid var(--primary); }
.header-logo { width: 60px; border-radius: 50%; }
.booking-container { display: flex; flex-direction: column; align-items: center; padding: 20px; }
.booking-card { background: white; border-radius: 15px; padding: 25px; width: 100%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.input-group { margin-bottom: 12px; }
input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
.row { display: flex; gap: 10px; } .col { flex: 1; }
.price-summary-card { background: #fff3e0; padding: 15px; border-radius: 10px; text-align: center; margin: 15px 0; border-left: 5px solid var(--primary); }
.monthly-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 30px; font-weight: bold; cursor: pointer; }

/* TICKET JPEG STYLE */
.ticket-card { background: white; width: 320px; padding: 20px; border: 1px solid #eee; position: relative; border-radius: 0; }
.ticket-top-border { height: 6px; background: var(--primary); position: absolute; top: 0; left: 0; width: 100%; }
.paid-stamp-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); border: 4px solid rgba(211, 47, 47, 0.2); color: rgba(211, 47, 47, 0.2); font-size: 2.5rem; font-weight: 900; padding: 5px; z-index: 0; }
.ticket-header { text-align: center; margin-bottom: 15px; }
.ticket-logo { width: 50px; }
.t-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 0.85rem; }
.divider { border-top: 1px dashed #ccc; margin: 8px 0; }
.price-highlight { background: #e8f5e9; padding: 8px; text-align: center; border-radius: 8px; margin-top: 10px; }
.price-highlight b { font-size: 1.1rem; color: #2e7d32; }

.ticket-actions { margin-top: 20px; width: 320px; }
.btn-jpg { width: 100%; background: #25d366; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; }
.hidden { display: none; }
.spinner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</body>
    </html>
    
